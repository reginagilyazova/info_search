Мобильные устройства изнутри. Что такое GPT?
vin2809

 
 
Продолжаем рассматривать строение программной части ( ) мобильных устройств ( ). Сегодня поговорим об устройстве  -раздела памяти. Написать об этом меня побудила публикация  , вместо того, чтобы писать комментарии к ней. Я хотел бы не поругать или поправить автора, а дополнить вышеуказанную публикацию с уклоном в  . 
 
 
Итак, GPT (GUID Partition Table) это: 
 
 
Существует две схемы разметки памяти:   и  . Каждая схема содержится в отдельном разделе памяти, называемом, соответственно,   или  . 
 
Как устроена  -схема разметки можно посмотреть в  , а   это другой формат описания разметки памяти — GUID (GUID Partition Table). Он является частью EFI (Extensible Firmware Interface) — стандарта  , используемого вместо BIOS для загрузки разделов памяти. 
 
Переход на другой формат позволил устранить самый существенный недостаток MBR-формата — малое число разделов. Если в   помещалось только 4 записи с ограничением на длину раздела и его смещение из-за того, что эти параметры описывались 32-разрядными числами, то в   можно разместить 128 записей о разделах. Причем их параметры уже описываются в 64-разрядной системе счисления… 
 
Для совместимости со старым стандартом загрузки (BIOS) и с целью защиты самой таблицы описания разделов памяти  -раздел тоже начинается с  , которая описывает всего один раздел — всю память МУ. Сама   называется теперь «защитной» (protective), т.е. PMBR. Она располагается тоже в первом секторе памяти по адресу   (512 байт). Поле   указывает на начало заголовка  , а размер раздела устанавливается равным длине всей памяти устройства. Тип раздела имеет значение   (GPT-раздел). 
 
Суть защиты  -раздела да и всей памяти   сводится к следующему. Если такой раздел откроет средство работы с  -схемой разметки, то оно увидит пустую неразмеченную память, состоящую только из раздела описания разметки. Соответственно, что-либо сделать с этой памятью ему не удасться. 
 
Вот как выглядит  , например, от МУ ...: 
 
   
  «Защитная» MBR, т.е. PMBR 
 
По адресу   видна сигнатура   (0xAA55). 
 
Перейдем к рассмотрению непосредственно структуры  -раздела. 
 
 
 -раздел состоит из  , заголовка и таблицы описания разделов памяти. 
 
Сразу за  , т.е. с адреса  , располагается  , имеющий длину 0х5С (92) байта, но занимающий весь сектор (512 байт). Вот как он выглядит в том же  : 
 
   
  Заголовок GPT 
 
Он имеет следующую структуру: 
 
 
Поле   содержит строка символов «EFI PART» — 45h 46h 49h 20h 50h 41h 52h 54h, которая выделена на рис.2 бирюзовым цветом и однозначно идентифицирует GPT-раздел. 
 
Поле  , выделенное зеленым цветом, содержит номер версии структуры GPT-раздела (0х00010000). Например, для GPT версии 1.0 должно быть 00h 00h 01h 00h 
 
Поле  , выделенное оранжевым цветом, содержит размер заголовка, выраженный в байтах. Пока это 0х0000005Ch, что означает 92 байта. 
 
Поле  , выделенное розовым цветом, содержит контрольную сумму заголовка (0x09BE8E1F), расчитанную по алгоритму CRC32. При непосредственном выполнении расчета учитываются только 92 байта, а в это поле перед расчетом заносится 0. 
 
Следующее поле   никак не выделено, является резервным и содержит 0. 
 
Поле  , выделенное темно-синим цветом, содержит смещение в блоках размещения первичного GPT-раздела (0х00000001). 
 
Поле   содержит смещение в блоках размещения резервного GPT-раздела. Оно не указано. 
 
Поле  , выделенное красным цветом, содержит смещение в блоках размещения первого разрешенного для использования сектора памяти (0х00000022). Расчитывается так: LBA последнего сектора, занятого первичным GPT-разделом, + 1. 
 
Поле   содержит смещение размещения последнего сектора памяти, разрешенного для использования. Расчитывается так: LBA первого сектора резервного GPT-раздела — 1. Оно не указано. 
 
Поле  , выделенное голубым цветом, содержит GUID прошивки. 
 
Поле  , выделенное красным цветом, содержит смещение начала GPT. В первичном всегда равен 2, а в резервном равен LastUsableLBA. 
 
Поле  , выделенное ярко-зеленым цветом, содержит размер таблицы описания разделов, т.е. число записей о разделах (0х00000018). 
 
Поле  , выделенное розовым цветом, содержит размер одной записи о разделе в байтах. Согласно   размер записи фиксирован и составляет 128 байт или 0х00000080. 
 
Поле  , выделенное красным цветом, содержит контрольную сумму таблицы описания разделов (0x93D54D33), расчитанную по алгоритму CRC32. При выполнении расчета учитываются все байты, начиная с PartitionsLBA и до FirstUsableLBA. 
 
Поле   содержит резервное поле. Содержит 0 до конца сектора, т.е. 420 байт для сектора размером 512 байт. 
 
Непосредственно сразу за заголовком, начиная с адреса  , располагается таблица описания разделов, содержащая записи о каждом разделе памяти, включая и сам раздел разметки. Вот как она выглядит: 
 
 
   Таблица описания разделов 
 
Каждая запись размером 128 байт имеет следующую структуру: 
 
 
Поле  , выделенное красным цветом, содержит GUID типа раздела, который определяет файловую систему, используемую для хранения данных в этом разделе. Каждая файловая система получает свой GUID, однозначно её идентифицирующий. Стандарт UEFI жестко определяет только следующие GUID типов разделов: 
 
 
Поставщикам ОС (vendors) нужно генерировать свой собственный GUID типа раздела, чтобы идентифицировать их. Некоторые известные GUID можно посмотреть в  . 
 
При записи в память или в файл-образ значение GUID записывается в другом порядке. Например, GUID системного раздела EFI имеет следующий вид: C12A7328-F81F-11D2-BA4B-00A0C93EC93B. Порядок записи байтов в написаниях GUID является little-endian, причем задом наперед пишутся байты только в первых трех блоках. Для приведенного выше GUID запись в таблице разделов будет иметь такой вид: 
 
   
Поле  , выделенное синим цветом, содержит GUID раздела. Является уникальным идентификатором раздела, поэтому создается каждый раз, когда создается раздел. 
  
Поле  , выделенное зеленым цветом, содержит смещение в блоках на первый сектор раздела (0x00020000). 
  
Поле  , выделенное оранжевым цветом, содержит смещение на последний сектор раздела (0x0003FFFF). При этом размер раздела (PartitionSize) определяется по формуле 
 
   
Поле  , выделенное фиолетовымым цветом, содержит атрибуты (флаги) раздела. 8 байт (64 бита) флагов распределены следующим образом. Биты с 0 по 47 (48 шт.) отведены под общие атрибуты типов разделов, а остальные 16 битов (с 48 по 63) описывают конкретный раздел. 
 
Вот небольшое описание этих битов: 
 
 
Поле  , выделенное синим цветом, содержит метку раздела («modem»), содержащую строку текста с завершающим нулем числом не более 36 символов, выраженную в кодировке UTF-16LE. 
 
Все, что такое GPT мы уже знаем, только это стандартная структура  -раздела. Оказывается, имеется и модификация… 
 
Т.к. я обнаружил  -раздел другой структуры при работе с   на основе чипа  , то я и назвал ее  . 
 
 
Прошивка новых мобильных устройств (МУ) Lenovo, выполненных на основе чипов  , имеет  -схему разметки памяти, но структура самого  -файла отличается от стандартной, описанной в [1]. Это касается, например, устройств YOGA BOOK YB1-X90. 
 
По сравнению со стандартной структурой  -тип сокращен до максимума: 
  
 
Т.к. структура  -файла этого типа отличается от стандартной структуры, то для его прошивки необходимо использовать специальный флешер фирмы   — PhoneFlashTool_5.3.2.0. 
  
 -раздел, как и стандартный, состоит из: 
  
 
 
   Строение Gpt-файла Intel-типа 
  
Рассмотрим строение заголовка. 
 
 
Заголовок имеет размер всего 12 ( ) байт (против 512 в стандартном варианте): 
 
 
   Заголовок Gpt-файла Intel-типа 
 
и содержит следующие поля: 
 
 
Поле  , отмеченное синим цветом, содержит число  , идентифицирующее образ  . 
 
Поле  , отмеченное красным цветом, содержит значение смещения размещения первого раздела памяти. 
 
Поле  , отмеченное зеленым цветом, содержит общее число разделов памяти, т.е. число записей таблицы описания разделов. Сама таблица расположена сразу после заголовка. 
 
 
Таблица описания разделов содержит записи, содержащие параметры каждого раздела памяти. Число записей равно числу разделов, а окончание таблицы ничем не отмечается. 
 
Каждая запись имеет размер 108 ( ) байт, тогда как по   она содержала 128 байт. Вот как выглядит запись описания раздела нового формата:  
 
 
   Запись описания раздела 
 
и содержит следующие поля, описывающие параметры раздела: 
 
   
Поле  , выделенное на рис.6 синим цветом, содержит размер раздела, выраженный в Мб (1024 * 1024 = 1048576 байт). 
 
Поле  , выделенное на рис.6 красным цветом, содержит метку раздела, т.е. имя раздела, выраженное в кодировке UTF-16. 
 
Поле  , выделенное на рис.6 зеленым цветом, содержит GUID типа раздела. 
 
Поле  , выделенное на рис.6 желтым цветом, содержит GUID самого раздела. 
 
 
Изучив строение  -раздела разметки памяти  , можно приступить и к практическим занятиям. 
 
В следующих публикациях я поделюсь опытом переразметки памяти  , выполненного по  -схеме. 
