Автоматическое переключение маршрута в Juniper SRX
alk0v
Небольшая инструкция про то, как автоматизировать переключение сетевого маршрута в случае проблем с одним из линков. Дальше прошу под кат 
 
 
 
Легенда — есть две площадки, связанных по L2 транспорту через двух разных провайдеров. Нужно обеспечить связность между сетями через ISP1 (первичный маршрут). В случае проблем с ISP1 автоматически переключиться на ISP2.  
Устройства — Juniper SRX.  
 
Для простейшей реализация этой задачи достаточно на FW1 прописать статический маршрут в сеть 192.168.2.0 через 10.0.0.2 c меньшей метрикой и через 10.0.0.6 с большей. На FW2 наоборот. Но работать этот метод будет только при падении интерфейса в сторону одного из провайдеров, что на практике бывает очень редко, поэтому нужно контролировать состояние канала другим способом. 
 
Для этого в Juniper есть сервис  . Вот о его использовании в этом сценарии я и хочу рассказать. 
 
На FW1 у нас есть обычная статическая запись (на FW2 зеркальная через 10.0.0.1): 
 
 
В таблице маршрутизации видим эту запись: 
 
 
Настраиваем сервис RPM для контроля первичного соединения. Отправляем пинг на адрес 10.0.0.2 по 10 штук на тест с интервалом 5 сек (probe-interval 5). Интервал между тестами тоже 5 сек, т.е. у нас фактически идет непрерывный пинг каждые 5 сек. Если в течение теста мы потеряли 5 пингов подряд, тест считается проваленным. 
 
 
Настраиваем реакцию на тест. В случае, если тест провален, добавляем маршрут через ISP2 
 
 
Проверяем: 
 
 
На FW2 надо настроить зеркальную конфигурацию: 
 
 
Можно тестировать, отключаем один из интерфейсов (vlan из транка в сторону FW), чтобы физически линк остался живым. Теряем около 6 пингов из LAN1 в LAN2, примерно через 30 сек. видим на FW1 следующее: 
 
 
В таблице маршрутизации видим новую запись: 
 
 
При восстановлении соединения через ISP1 тест снова переходит в состояние PASS и убирает запись из таблицы маршрутизации.  
 
Обращаю внимание, что конфигурация должна быть зеркальной для обоих устройств. 
Если статических маршрутов несколько, их можно добавлять новыми строками then. Условий также может быть несколько, это достаточно гибкий метод. 
 
Всем спасибо, надеюсь, это сэкономит кому-то время.
