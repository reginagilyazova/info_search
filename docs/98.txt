Мобильные устройства изнутри. Разметка памяти, структура файлов описания и разметки памяти
vin2809

Как оказалось, разметка физической памяти мобильных устройств (МУ) это малоописанный раздел знаний, необходимых разработчику. Т.к. память существует во всех устройствах, созданных на основе микропроцессоров или микроконтроллеров, а их уже миллиарды, то это еще и очень-очень востребованный раздел знаний. 
 
Эта статья посвящена аспектам разметки памяти только МУ, т.к. именно здесь существует тесно свитый разными производителями клубок из файлов описания разметки при почти полном отсутствии теоретических данных о структуре самих этих файлов. 
 
Разметка физической памяти МУ формируется на основании таблиц или списков описаний параметров разделов памяти. Практически каждая фирма-производитель МУ имеет свою форму (структуру) этих таблиц. Тем не менее, все описания параметров разделов имеют много общего, что позволяет рассматривать их в едином контексте. 
 
На основе таблиц описаний затем формируются файлы разметки памяти, которые в виде образов разделов прошиваются непосредственно в память МУ. 
 
 
Подробнее, что представляет собой разметка памяти МУ и для чего это нужно, можно посмотреть, например, в [1]. Вот еще одна публикация, в которой доступно объясняется устройство памяти и ее разметка [2]. 
 
Если кратко, то разметка памяти, как процесс, выполняет распределение всего объема внутренней физической памяти МУ на отдельные разделы, которые могут иметь разное функциональное назначение, вплоть до разных файловых систем, и разные права доступа. Это позволяет выделить в памяти отдельно области для хранения данных и работы пользователя, отдельно для работы операционной системы, шифровать или форматировать разделы при необходимости и независимо друг от друга и т.д. 
 
При выполнении разметки разработчик МУ должен придерживаться некоторых правил, которые называются схемами разметки памяти. Схема разметки описывает размещение всех разделов физической памяти: их очередность, смещение и название, т.е. метку или имя раздела. Могут указываться и другие параметры: его размер, тип, регион, флаги и т.п. 
 
Для выполнения разметки памяти используют файлы двух видов: текстовые и бинарные (двоичные RAW-файлы). 
 
Текстовый файл представляет собой перечень (список) всех разделов памяти, каждая запись которого содержит описание основных параметров этих разделов. Он используется при выполнении нескольких операций: 
 
 
Бинарный файл разметки содержит разметку памяти в структурированном виде, понятном для работы операционных систем (ОС). Он размещается в прошивке МУ и затем прошивается в раздел разметки непосредственно в физическую память. 
 
Процесс создания разметки памяти можно описать следующим алгоритмом: 
 
 
Давайте рассмотрим схемы разметки памяти и строение таблиц описаний параметров подробнее. 
 
 
Чаще всего применяются две схемы разметки памяти:   и  . 
 
При любой схеме разметки памяти первым по порядку разделом в пользовательском регионе МУ всегда должен быть раздел разметки (Mbr, Gpt, Parameter). 
 
 
Согласно  -схеме память МУ представляется как последовательность разделов, дополненная главной загрузочной записью или   (Master Boot Record), содержащей таблицу описания разделов.   физически располагается в первом (нулевом) секторе памяти МУ: 
 
 
  
 
  содержит сигнатуру, т.е. признак  , и непосредственно саму таблицу описания разделов. 
 
Внутреннее строение   [3] позволяет разместить в ней только 4 записи о разделах, что является в современных условиях существенным недостатком. Если требуется разбить память на большее количество разделов, то используется дополнительная (расширенная) загрузочная запись Extended Boot Record ( ). При этом в   вместо записи об одном из разделов помещается запись о дополнительном (extended) разделе, содержащем только  . 
 
Сама   устроена аналогично  , и использовать ее нужно точно также. Т.е., если при заполнении таблицы   опять не хватает места под записи о разделах, то создается следующая  -таблица и т.д. 
 
  и все   могут помещаться в отдельные файлы-образы, которые размещаются и прошиваются в соответствующих отдельных разделах памяти. При этом все файлы, содержащие  , имеют имена нумерованные последовательно:  ,  ,… 
 
При другом варианте   помещаются в один файл-образ последовательно, тогда этот образ, соответственно, размещается в одном  -разделе памяти. 
 
 
 -схема разметки (GUID Partition Table) является частью   (Extensible Firmware Interface) — стандарта, используемого вместо   для разметки памяти и загрузки ее разделов. Переход на другой формат описания разделов позволил устранить самый существенный недостаток  -схемы — малое число разделов, т.к. в таблице описания разделов   можно разместить до 128 разделов. Структуру самих таблиц можно посмотреть в [4]. 
 
Согласно  -схеме память МУ тоже представляет собой последовательность разделов, необходимых для работы МУ, дополненную спереди  -таблицей описания разделов, называемой основной. При этом после всех разделов размещается дополнительная  -таблица, называемая резервной. Такое расположение таблиц, теоретически, повышает надежность разметки, т.к. при сбое или порче основной  -таблицы ОС может использовать для работы, или восстановления основной, резервную. 
 
 
Таблицы описания разделов памяти МУ содержат информацию о всех разделах, необходимую для создания разметки памяти. Каждая строка (запись) таблицы описывает один раздел и содержит, как правило, следующие параметры: 
 
 
Т.к. эти таблицы используются производителями МУ при выполнении непосредственно прошивки образов разделов в память при помощи флешеров (программаторов), то записи могут содержать дополнительные параметры, требуемые для правильной настройки свойств разделов, например: 
 
 
Физически таблицы описания разделов представляют собой текстовые файлы формата txt или xml. В моей практике встречались следующие их разновидности: 
 
 
Давайте рассмотрим их строение подробнее. 
 
 
Прошивка МУ на чипе   содержит текстовый файл  , который предназначен для описания построения (настройки и загрузки) физической памяти блочного типа. Причем использовался он и на ОС LINUX. 
 
Оригинальный вид содержимого файла   для МУ Cube u30gt-M приведен ниже: 
 
 
 
Файл   может содержать следующие параметры: 
 
 
Самый большой интерес для разработчика представляет параметр  . Он содержит набор значений ключей для настройки Вашего устройства. 
Рассмотрим строение параметра   отдельно. 
 
 
Формат командной строки, т.е.  , имеет следующий вид: 
 
 
   
Вот список возможных ключей: 
 
 
В свою очередь параметр   имеет следующее строение: 
 
 
  — описание разметки памяти устройства блочного типа (БУ). Если МУ содержит несколько БУ, то может содержать и несколько описаний, которые располагаются последовательно без промежутка и разделяются символом «точка с запятой». 
  
Описание разметки памяти каждого БУ имеет следующее строение: 
 
 
   
Каждая запись   содержит описание одного раздела памяти, за единицу измерения принят блок, размер которого составляет 0х200(512) байт, и имеет следующую структуру: 
 
 
Параметр   описывает размер раздела в блоках, выраженный в hex-системе счисления. Если вместо размера указан символ «минус» ("-"), это означает максимально возможный размер, т.е. до физического конца памяти. 
 
Параметр   представляет смещение раздела в блоках, выраженный в hex-системе счисления. Смещение всегда выравнивается на границу в 0х1000. 
 
Параметр   (имя раздела) это строковый идентификатор раздела, заключенный в круглые скобки, например, (boot). 
 
Параметр   (флаг) может принимать только одно значение — " ", означающее, что раздел предназначен только для чтения. Отсутствие флага означает, что раздел доступен для чтения и записи. 
  
 
 
 
 
Файл   предназначен для описания разметки памяти МУ на основе чипов   и имеет следующее строение: 
 
   
 
Он содержит таблицу описания параметров разделов в виде xml-элементов типа  . Все разделы перечисляются строго в порядке их размещения в памяти МУ. 
 
Каждый xml-элемент может содержать следующие xml-атрибуты: 
 
 
 
Это единственный файл описаний, который описывает строение файла прошивки, а не разметку памяти. 
 
Например, файл ota-обновления МУ на чипе МТ6582 фирмы  , имеет следующий вид: 
 
   
 
Он содержит описание тех разделов, чьи образы присутствуют в файле прошивки для ota-обновления, каждое из которых имеет следующее строение: 
 
 
  
   
Все образы в прошивке размещены строго последовательно без «дыр», поэтому размер каждого образа раздела   вычисляется по следующей формуле: 
 
 
 
 
Файл scatter содержит описание разметки памяти МУ, построенных на основе чипов  . Существует три версии структуры этого файла, что связано с историческим развитием возможностей как самих чипов памяти, так и чипов процессоров фирмы  . 
 
 
Файл описаний разметки первой версии содержит список описаний каждого раздела памяти, и имеет следующий вид: 
 
 
 
Каждый раздел памяти описывается следующей структурой: 
 
 
 
Чаще всего используется сокращенная запись вида: 
 
 
Такое описание разделов памяти предполагает, что: 
 
 
 
Scatter-файл описаний разметки памяти второй версии содержит заголовок и непосредственно таблицу описаний каждого раздела памяти. Он имеет следующий вид: 
 
 
 
Заголовок содержит параметры прошивки целиком и содержит следующие поля: 
 
 
Каждый раздел памяти описывается следующим набором полей: 
 
   — метка раздела; 
   — имя раздела; 
   — имя файла, содержащего образ для прошивания в разделе, или NONE, если образ не требуется; 
   — признак загружаемости раздела (что-то типа  ); 
   — тип раздела. Указывает на содержимое раздела. Может принимать следующие значения: 
     — смещение раздела в файле прошивки, байт; 
   — смещение раздела в памяти МУ (физический адрес), байт; 
   — размер раздела в байтах; 
   — название региона размещения раздела. Может принимать следующие значения: 
     — название хранилища размещения раздела; 
    — признак необходимости выравнивания границы раздела; 
   — признак необходимости резервного копирования; 
   — тип операции. Может принимать следующие значения: 
 
При работе флешер из таблицы описания разделов выбирает параметры, основными являются   и  . 
 
Для чипов МТ6572-МТ6577 в качестве значения   флешером используется значение поля  , отражающее истинное смещение раздела в памяти (представляющей один сплошной регион), т.к. чипы не умеют работать с регионами, а используемая память имела только один регион для размещения разделов. При этом значение поля «physical_start_addr» всегда равно нулю. 
 
Чипы МТ6582 уже умеют работать с регионами, но используемая память еще имеет только один регион. Поэтому в качестве значения   флешером уже используется значение поля  , отражающее смещение раздела в пределах регионов, создаваемых в памяти программно, а поле   содержит значения смещения от начала чипа памяти. 
 
В связи с тем, что, начиная с чипа МТ6592, МУ от МТК используют полноценную работу с регионами памяти, то для чипов МТ6592 и выше флешером в качестве значения   используется значение поля  . 
 
Значение поля   флешер всегда получает из поля  . 
 
 
Файлы разметки памяти содержат образ раздела разметки памяти МУ. Их структура зависит от схемы разметки (  или  ) и от назначения, например, резервные файлы разметки   или  . 
 
Встречаются следующие виды файлов разметки: 
 
 
 
 -файл представляет собой образ раздела разметки памяти по  -схеме, имеющий размер 1 сектор, т.е. 512 байт. 
В МУ применяется так называемая классическая структура  -файла [5]: 
 
  
 
Каждая запись параметров раздела содержит следующие поля, значения которых отличается от принятых в классической структуре  : 
 
   
Поле   имеет размер 1 байт и используется для обозначения активности раздела, старший бит которого указывает на загрузочный раздел: 
 
 
Поле   имеет размер 1 байт и используется производителями МУ для обозначения типа описываемого раздела. Обозначение типа раздела у разных производителей могут отличаться, но есть некоторые общепринятые значения: 
 
 
Поле   имеет размер 4 байта и содержит значение смещения раздела, выраженное в секторах. 
 
Поле   имеет размер 4 байта и содержит значение размера раздела, выраженное тоже в секторах. 
 
По адресу 0x01FE расположена сигнатура  -файла, имеющая значение 0xAA55. 
  
 
 -файл представляет собой образ расширенного раздела разметки памяти, выполненной по  -схеме. Он имеет такое же строение и размер, как и  -файл: 
 
  
 
Отличия заключаются в том, что в  -файле признак активности всегда установлен в 0, да и этих файлов, при необходимости, может быть уже не один, а 63. Соответственно, для их размещения тоже понадобится создавать до 63 разделов, что приводит к расточительному расходованию памяти МУ. 
 
Если разделов памяти относительно немного, например, как в МУ Star Z2, то используются отдельные файлы   и  , размещаемые в отдельных разделах. Но, если разделов много, например,, то все файлы   можно сложить в один и разместить общий файл в одном разделе памяти. 
 
 
 -файл содержит образ разметки памяти по  -схеме. Чаще всего МУ имеют стандартную структуру  -схемы, поэтому, фактически, в прошивке имеется два  -файла: основной, называемый   ( ) или  , и вторичный (резервный), называемый   ( ) или  . 
 
Основной  -файл располагается в памяти МУ, начиная с нулевого сектора, занимает 34 сектора и имеет следующее строение: 
 
 
Резервный  -файл занимает 33 сектора и располагается в памяти МУ, вплотную к концу памяти, так, что последний сектор  -файла располагается в физически последнем секторе памяти. Он имеет следующее строение: 
 
   
 
 -файл, т.е. образ раздела, содержащего разметку памяти, содержит только сам текстовый файл  , причем независимо от размеров этого раздела. Вот как Parameter-файл выглядит, например, внутри прошивки для устройства U30GT-H фирмы RK [6]: 
 
  
  
 
 -файл представляет собой образ резервного раздела разметки памяти, используемой разработчиками МУ фирмы  , и имеет размер 4096 байт. 
 
Образ раздела   состоит из двух таблиц описания разделов памяти. В начале расположена базовая, а следом за ней резервная или зеркальная (mirror) таблица описания разделов. 
 
Каждая из таблиц состоит из: 
 
 
Структура каждой записи имеет размер 0х58 (88) байт состоит из 4 полей и имеет следующий вид: 
 
 
 
 -файл ( ) представляет собой образ раздела разметки памяти, используемой разработчиками МУ фирмы  , и имеет размер 4096 байт. Информация по строению образа взята из [7, 8]. 
 
 -файл состоит из заголовка и таблицы описаний параметров разделов. 
 
Заголовок имеет размер 28 байт и содержит следующие поля: 
 
 
Следом располагается таблица описаний параметров разделов, состоящая из записей о разделах. Признак конца таблицы — пустая запись. Каждая запись содержит следующие поля: 
 
 
Поле   содержит тип операционной системы. Допустимы следующие значения: 
 
 
Поле   содержит тип устройства. Допустимы следующие значения: 
 
   
Поле   содержит порядковый номер раздела в прошивке. 
 
Поле   содержит флаги раздела. Может принимать значения: 
 
 
Поле   содержит флаги раздела при обновлении. Может принимать значения: 
 
   
Поле   содержит смещение раздела в памяти, выраженное в блоках. 
 
Поле   содержит размер раздела в памяти, выраженный в блоках. 
 
Поле   содержит смещение файла-образа в прошивке, выраженное в блоках. 
 
Поле   содержит размер файла-образа, выраженный в блоках. 
 
Поле   имеет длину 32 байта и содержит метку раздела памяти, завершенную нулем (0х00). 
 
Поле   содержит имя файла-образа раздела прошивки, завершенное нулем (0х00). 
 
Поле   содержит имя файла-образа раздела прошивки FOTA-обновления, завершенное нулем (0х00). 

