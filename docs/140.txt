Скрипт удаления универсальных приложений Магазина Windows
Ostan
Пришло время выложить из закромов очередной скрипт для системных администраторов. Заготовки для работы с   и   выкладывались в предыдущих статьях. Сегодня Я поделюсь готовым решением, которое можно без доработок применять в работе. Как известно, компания Microsoft решила последовать примеру Google и открыла свой маркет приложений, под названием  . В дистрибутивах ОС начиная c Windows 8 появились приложения нового типа (формат файлов распространения —  ), которые являются универсальными и должны запускаться на всех устройствах под Windows. Среди предустановленных универсальных приложений лично Я не нашел ничего полезного, поэтому и написал скрипт, который удаляет их все. 
 
Представленное здесь решение предназначено для обслуживания образов Windows 8, 8.1, 10. Может применяться как к автономным файлам образов в формате  , так и к развёрнутой (установленной) системе. Как и в предыдущих моих скриптах использую средства системы  . Однако в ходе разработки выяснилось, что с помощью команды   нет возможности удалить универсальные приложения из установленной системы (обслуживание онлайн) — только средствами  . Пришлось делать выбор: либо писать скрипт полностью на PS, либо использую возможности командного интерпретатора (CMD), осуществить вызов отдельных операций из PS. Я выбрал второй вариант, в связи с чем, представленное решение состоит из двух файлов: основного скрипта (сохранить с любым именем  ) и дополнительного (сохранить с именем  ). 
 
 
 
 
 
 
Два файла должны размещаться в одной папке. Если в папке запуска отсутствует файл образа —  , то скрипты выполняют работу в полностью автоматическом режиме. Если в папке запуска присутствует файл образа —  , то скрипт выполняет считывание из него информацию об имеющихся «индексах» и предлагает ввести номер. После этого отображается расширенная информация о выбранном «индексе» выдаётся запрос на монтирование. Нажатие любой клавиши приводит к возврату, а нажатие клавиши [m] запускает следующую цепочку действий: монтирование образа, проверка версии ОС, удаление дистрибутивов приложений (по циклу), удаление всех ассоциаций, деинсталляция установленных приложений (при запуске онлайн), размонтирование образа, возврат в меню выбора «индекса». После чего можно выбрать другой «индекс» образа для удаления приложений. Выбор «индекса» под номером 0 запускает обслуживание онлайн. 
 
 
 
 
 
 
 
 
Проверка версии целевой системы. Если оказывается, что скрипт пытаются применить к образу Windows 7, то происходит размонтирование. Иначе, выполняется переход к следующей метке. 
 
 
Основной блок выполнения скрипта. Вначале запрашивается список интегрированных универсальных приложений с сохранением во временный файл  . Затем в цикле   из полученного списка последовательно выбираются строки и передаются в псевдофункцию  . Строки фильтруются поиском по регулярному выражению   — если найдена, то передаются в следующую псевдофункцию  . Здесь по регулярному выражению   отфильтровываются названия универсальных приложений, передаваемые в дальнейшем утилите   для удаления. Чтобы лучше понять логику работы нужно взглянуть на содержимое файла  . Так как файл удаляется по завершению работы цикла, то чтобы с ним ознакомиться нужно предварительно вручную его получить и сохранить. 
 
Одной командой происходит удаление всех ассоциаций открытия отдельных файлов универсальными приложениями. Для распространённых типов файлов остаются ассоциации со стандартными классическими приложениями Windows. 
 
Удаление (деинсталляция) универсальных приложений на установленной системе происходит вызовом составной команды на языке скриптов PowerShell. Файл дополнительного скрипта   вначале выполняет запрос списка всех универсальных приложений для всех пользователей, а затем «по конвейеру» передаёт их команде на удаление. Вроде бы ничего сложного, однако, чтобы выполнить эту операцию скрипт PS должен быть запущен с повышенными правами, причём работать от имени Администратора не достаточно. Для успешного запуска нужно вставить тот сложный код в команде   чтобы получить повышение прав. Защита которая легко обходится! Вот за этот «идиотизм» мне и не приглянулся PowerShell. 
 
 
 
 
 
 
Я показал простой и быстрый способ удаления приложений Магазина Windows. Считаю, что одно и тоже приложение не может быть одинаково удобным для использования на мобильном устройстве и на ПК. Прежде всего у названных платформ разное функциональное назначение, а значит и требуемые пользователям приложения должные предоставлять разный функционал. После отработки скрипта несколько универсальных приложений всё же остаются, прежде всего это сам Магазин Windows, с помощью которого можно установить то, что было удалено или что-то ещё.
